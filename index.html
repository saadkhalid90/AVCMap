<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src="//d3js.org/topojson.v1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.css' rel='stylesheet' />

  <style>
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
    #map {
      position:absolute;
      width: 100%;
      height: 100%;
    }
    svg {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    .tooltip {
      position: fixed;
      width: 180px;
      background-color: rgb(125, 125, 125, 0.5);
      z-index: 2;
      color: white;
      padding: 5px;
    }

    .tooltipTitle {
      font-size: bold;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script>

    // setting up the mapbox gl map
    // first we specify the token
    mapboxgl.accessToken = 'pk.eyJ1IjoiZW5qYWxvdCIsImEiOiJjaWhtdmxhNTIwb25zdHBsejk0NGdhODJhIn0.2-F2hS_oTZenAWc0BMf_uw'

    //Setup mapbox-gl map
    const map = new mapboxgl.Map({
      container: 'map', // container id
      style: 'mapbox://styles/mapbox/dark-v10', // default style picked from mapbox gljs docs
      center: [66.9354, 30.7156], // picked a center coordinate for Pishin (Balochistan)
      zoom: 8,

    })
    map.scrollZoom.disable() // disable zoom on pinch
    map.addControl(new mapboxgl.NavigationControl()); // add navigation controls like zoom etc

    // Setup our svg layer that we can manipulate with d3
    // getting the container which contains the mapbox map
    const container = map.getCanvasContainer();
    // appending an svg to that container
    const svg = d3.select(container).append("svg");

    // we calculate the scale given mapbox state (derived from viewport-mercator-project's code)
    // to define a d3 projection
    const getD3 = () => {
      // get important data for the map that will be helpful to define D3 projection
      const bbox = document.body.getBoundingClientRect();
      const center = map.getCenter();
      const zoom = map.getZoom();
      // 512 is hardcoded tile size, might need to be 256 or changed to suit your map config

      const getD3projScal = (tileSize, zoom) => (tileSize) * 0.5 / Math.PI * Math.pow(2, zoom);
      const scale = getD3projScal(512, zoom);

      const d3projection = d3.geo.mercator()
        .center([center.lng, center.lat])
        .translate([bbox.width/2, bbox.height/2])
        .scale(scale);

      return d3projection;
    }
    // calculate the original d3 projection
    let d3Projection = getD3();

    const path = d3.geo.path()

    var url = "Farmer.csv";
    d3.csv(url, function(err, data) {
      //console.log(data[0], getLL(data[0]), project(data[0]))
      var dots = svg.selectAll("circle.dot")
        .data(data)

      dots.enter().append("circle").classed("dot", true)
      .attr("r", 1)
      .style({
        fill: "yellow",
        "fill-opacity": 0.5,
        stroke: "grey",
        "stroke-width": .5
      })
      .transition().duration(1000)
      .attr("r", 6)

      function render() {
        d3Projection = getD3();
        path.projection(d3Projection)

        dots
        .attr({
          cx: function(d) {
            var x = d3Projection([d.Coord_Lon, d.Coord_Lat])[0];
            return x
          },
          cy: function(d) {
            var y = d3Projection([d.Coord_Lon, d.Coord_Lat])[1];
            return y
          },
        })
      }

      // re-render our visualization whenever the view changes
      map.on("viewreset", function() {
        render()
      })
      map.on("move", function() {
        render()
      })

      svg.selectAll("circle.dot").on('mouseover', function(d, i){
        console.log('event-fired!')
        appendTooltip(d3.event, d);
      })

      svg.selectAll("circle.dot").on('mouseout', function(d, i){
        removeTooltip();
      })

      const appendTooltip = (event, dat) => {
        const toolTipWidth = 180;

        d3.select(container).append('div')
          .attr('class', 'tooltip')
          .html(`
            <p>
              <span class="tooltipTitle">District: </span>${dat.District}<br>
              <span class="tooltipTitle">Date: </span>${dat.today}<br>
              <span class="tooltipTitle">Enumerator: </span>${dat.Enumerator}
            </p>

          `)
          .style('top', `${event.y + 5}px`)
          .style('left', `${event.x - (toolTipWidth/2)}px`)
      }

      const removeTooltip = () => {
        d3.select(container).select('div.tooltip').remove();
      }

      // render our initial visualization
      render()
    })


  </script>
</body>
